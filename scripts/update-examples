#!/usr/bin/env python

"""Update the examples in this repo.

Make sure your environment is configured to access the AWS bucket.
"""

import shutil
from pathlib import Path

from obstore.store import S3Store
from pystac import Catalog, CatalogType, Collection

from stactools.met_office_deterministic import stac
from stactools.met_office_deterministic.href import Href

root = Path(__file__).parents[1]
examples = root / "examples"
bucket = "met-office-atmospheric-model-data"

if examples.exists():
    shutil.rmtree(examples)
    examples.mkdir()

catalog = Catalog(
    "met-office-deterministic",
    description="Met Office Deterministic atmospheric model data",
)

store = S3Store(bucket, config={"region": "eu-west-2"})
object_metas = list()
for list_result in store.list("uk-deterministic-2km/20250614T0000Z/"):
    object_metas.extend(list_result)
for list_result in store.list("global-deterministic-10km/20250614T0000Z/"):
    object_metas.extend(list_result)

collections: dict[tuple[str, str], Collection] = dict()
hrefs = list()
for object_meta in object_metas:
    href = Href.parse(f"s3://{bucket}/{object_meta['path']}")
    hrefs.append(href)
    key = (href.model, href.theme)
    if key not in collections:
        collections[key] = stac.create_collection(href.model, href.theme)

for item in stac.create_items(hrefs):
    key = (
        item.properties["met_office_deterministic:model"],
        item.properties["met_office_deterministic:theme"],
    )
    collections[key].add_item(item)

for collection in collections.values():
    catalog.add_child(collection)

catalog.normalize_hrefs(str(examples))
catalog.save(CatalogType.SELF_CONTAINED)
